<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Pro æ™ºèƒ½åŠ©å­¦ç³»ç»Ÿ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* ==============================================
           2. CSS æ ·å¼ç³»ç»Ÿ
        =============================================== */

        /* --- å…¨å±€å˜é‡å®šä¹‰ (æ–¹ä¾¿æ¢è‚¤) --- */
        :root {
            /* æµ…è‰²æ¨¡å¼ (Light Mode) */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-gradient: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.6);
            --text-main: #2c3e50;
            --text-sub: #666;
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --nav-bg: rgba(255, 255, 255, 0.95);
            --success-color: #00b09b;
            --danger-color: #ff5f6d;
        }

        /* --- æ·±è‰²æ¨¡å¼ (Dark Mode) è¦†ç›–å˜é‡ --- */
        [data-theme="dark"] {
            --primary-gradient: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            --bg-gradient: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            --glass-bg: rgba(30, 30, 40, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f5f7fa;
            --text-sub: #b0bec5;
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --nav-bg: rgba(30, 30, 40, 0.95);
        }

        /* --- åŸºç¡€å¸ƒå±€ --- */
        body {
            background: var(--bg-gradient);
            font-family: 'Nunito', 'Microsoft YaHei', sans-serif;
            min-height: 100vh;
            padding-bottom: 100px; /* ç»™åº•éƒ¨å¯¼èˆªæ ç•™ä½ç½® */
            overflow-x: hidden;
            color: var(--text-main);
            transition: background 0.5s ease; /* ä¸»é¢˜åˆ‡æ¢æ—¶çš„ä¸æ»‘è¿‡æ¸¡ */
        }

        /* --- ç™»å½•/æ³¨å†Œé¡µé¢æ ·å¼ --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        .login-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            padding: 40px 30px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            width: 85%;
            max-width: 360px;
        }

        .login-input {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: none;
            background: rgba(0,0,0,0.05);
            border-radius: 12px;
            outline: none;
            transition: 0.3s;
            color: var(--text-main);
        }

        .login-input:focus {
            background: rgba(255,255,255,0.5);
            box-shadow: 0 0 0 2px #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            margin-top: 20px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .login-btn:active {
            transform: scale(0.95);
        }

        /* --- ä¸»ç•Œé¢å®¹å™¨ (é»˜è®¤éšè—) --- */
        #main-app {
            display: none;
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        /* --- æ ¸å¿ƒç»„ä»¶ï¼šæ¯›ç»ç’ƒå¡ç‰‡ --- */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--card-shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.3s;
        }

        .glass-card:hover {
            transform: translateY(-3px);
        }

        /* å•è¯å¤§å­—ç‰¹æ•ˆ */
        .word-text {
            font-size: 3.5rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        /* --- åº•éƒ¨æ‚¬æµ®å¯¼èˆªæ  --- */
        .bottom-nav {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 94%;
            max-width: 500px;
            background: var(--nav-bg);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 10px 5px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-around;
            z-index: 1000;
            border: 1px solid var(--glass-border);
        }

        .nav-item {
            border: none;
            background: none;
            color: #999;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: 0.3s;
            cursor: pointer;
        }

        .nav-item.active {
            color: #8e44ad;
            transform: translateY(-4px);
        }

        [data-theme="dark"] .nav-item.active {
            color: #fbc2eb;
        }

        /* --- åŠ¨ç”»ç‰¹æ•ˆ --- */
        /* å½•éŸ³æ—¶çš„å‘¼å¸ç¯æ•ˆæœ */
        .mic-btn.recording {
            animation: pulse 1.5s infinite;
            background: var(--danger-color) !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 95, 109, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(255, 95, 109, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 95, 109, 0); }
        }

        /* æé€ŸæŒ‘æˆ˜å€’è®¡æ—¶æ¡ */
        .timer-bar {
            height: 5px;
            background: linear-gradient(90deg, #00b09b, #96c93d);
            width: 100%;
            transition: width 1s linear;
        }

        /* --- ç­›é€‰å™¨æ ‡ç­¾æ ·å¼ --- */
        .filter-modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: none;
        }
        [data-theme="dark"] .filter-modal-content {
            background: rgba(30, 30, 40, 0.95);
            color: #fff;
        }

        .filter-chip {
            display: inline-block;
            padding: 6px 12px;
            margin: 0 5px 8px 0;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            background: #f0f2f5;
            color: #555;
            border: 1px solid transparent;
            transition: all 0.2s;
        }

        .filter-chip.active {
            background: #6a11cb;
            color: white;
            box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
        }

        /* --- æ‹¼å†™ç•Œé¢ï¼šéš¾åº¦é€‰æ‹©æŒ‰é’® --- */
        .spell-diff-btn {
            border: 1px solid transparent;
            font-size: 0.85rem;
            padding: 5px 15px;
            background: rgba(255,255,255,0.5);
            color: #666;
            transition: all 0.2s;
        }
        .spell-diff-btn.active-easy { background: #2ecc71; color: white; border-color: #27ae60; }
        .spell-diff-btn.active-mid { background: #f1c40f; color: #fff; border-color: #f39c12; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .spell-diff-btn.active-hard { background: #ff4757; color: white; border-color: #c0392b; }

        /* --- å‹‹ç« å¢™æ ·å¼ --- */
        .badge-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        .achievement-badge {
            background: rgba(255,255,255,0.5);
            border-radius: 15px;
            padding: 10px 5px;
            text-align: center;
            filter: grayscale(100%); /* æœªè§£é”å˜ç° */
            opacity: 0.6;
            transition: all 0.5s;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .achievement-badge.unlocked {
            filter: grayscale(0%); /* è§£é”åå½©è‰² */
            opacity: 1;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: scale(1.05);
        }
        [data-theme="dark"] .achievement-badge.unlocked {
            background: #3e4c59;
        }
        
        .badge-icon { font-size: 2rem; display: block; margin-bottom: 5px; }
        .badge-name { font-size: 0.75rem; font-weight: bold; color: var(--text-main); display: block;}
        .badge-req { font-size: 0.6rem; color: var(--text-sub); }

        /* --- åˆ—è¡¨è¡¨æ ¼é€‚é… --- */
        .table-custom { font-size: 0.9rem; }
        .table-custom td { color: var(--text-main); border-bottom: 1px solid rgba(0,0,0,0.05); }
        [data-theme="dark"] .table-custom td { border-bottom: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card" id="login-box">
            <h1 style="font-size: 50px; margin-bottom: 10px;">ğŸª</h1>
            <h2 class="fw-bold mb-2">English Pro</h2>
            <p class="text-muted mb-4 small">æ——èˆ°æ™ºèƒ½åŠ©å­¦ç³»ç»Ÿ</p>
            
            <input type="text" id="login-user" class="login-input" placeholder="è¾“å…¥è´¦å· (User ID)">
            <input type="password" id="login-pass" class="login-input" placeholder="è¾“å…¥å¯†ç  (Password)">
            
            <button class="login-btn" onclick="handleLogin()">ç™» å½• (Login) ğŸš€</button>
            <div class="mt-4 small text-muted" onclick="showRegister()" style="cursor:pointer; text-decoration:underline;">
                æ²¡æœ‰è´¦å·ï¼Ÿå»æ³¨å†Œ
            </div>
        </div>
        
        <div class="login-card" id="register-box" style="display: none;">
            <h3 class="fw-bold mb-3">æ–°ç”¨æˆ·æ³¨å†Œ</h3>
            <input type="text" id="reg-user" class="login-input" placeholder="è®¾ç½®è´¦å·">
            <input type="password" id="reg-pass" class="login-input" placeholder="è®¾ç½®å¯†ç ">
            
            <button class="login-btn" style="background: linear-gradient(135deg, #00b09b, #96c93d);" onclick="handleRegister()">æ³¨ å†Œ (Sign Up)</button>
            <div class="mt-4 small text-muted" onclick="showLogin()" style="cursor:pointer; text-decoration:underline;">
                è¿”å›ç™»å½•
            </div>
        </div>
    </div>

    <div id="main-app" class="container pt-3">
        
        <div class="d-flex justify-content-between align-items-center mb-4 px-2">
            <div class="d-flex align-items-center">
                <img src="" id="user-avatar" class="rounded-circle shadow-sm me-2 border border-2 border-white" width="45" height="45">
                <div>
                    <h6 class="fw-bold mb-0 text-main" id="welcome-name">User</h6>
                    <small class="text-muted" style="font-size: 0.75rem;">
                        ğŸ”¥ è¿èƒœ: <span id="streak-days">0</span> å¤©
                    </small>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-light rounded-circle shadow-sm" onclick="toggleTheme()" style="width: 40px; height: 40px;">ğŸŒ“</button>
                
                <div class="dropdown">
                    <button class="btn btn-light rounded-circle shadow-sm fw-bold text-primary" data-bs-toggle="dropdown" style="width: 40px; height: 40px;">ğŸ“š</button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-4 p-2">
                        <li><h6 class="dropdown-header">è¯åº“é€‰æ‹©</h6></li>
                        <li><a class="dropdown-item rounded-3" onclick="filterUnit('all')">ğŸ“š å…¨éƒ¨å•è¯</a></li>
                        <li><a class="dropdown-item rounded-3" onclick="filterUnit('ä¸ƒå¹´çº§(å…¨)')">ğŸ“— ä¸ƒå¹´çº§</a></li>
                        <li><a class="dropdown-item rounded-3" onclick="filterUnit('å…«å¹´çº§(å…¨)')">ğŸ“˜ å…«å¹´çº§</a></li>
                        <li><a class="dropdown-item rounded-3" onclick="filterUnit('ä¹å¹´çº§(å…¨)')">ğŸ“™ ä¹å¹´çº§</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" onclick="logout()">ğŸ”’ é€€å‡ºç™»å½•</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="glass-card py-2 px-3 mb-3 d-flex align-items-center">
            <span class="fs-4 me-2">ğŸ’¡</span>
            <span class="text-muted small fst-italic text-truncate" id="daily-quote" style="max-width: 90%;">Loading quote...</span>
        </div>

        <div class="glass-card py-2 mb-3 d-flex align-items-center justify-content-between" style="padding: 10px 20px; border-radius: 50px;">
            <div class="d-flex align-items-center flex-grow-1">
                <span class="me-2 text-muted">ğŸ”</span>
                <input type="text" class="form-control border-0 bg-transparent p-0 login-input m-0" style="background:none;" placeholder="æœç´¢å•è¯..." oninput="searchWord(this.value)">
            </div>
            <button class="btn btn-sm btn-outline-secondary rounded-pill ms-2 px-3" data-bs-toggle="modal" data-bs-target="#filterModal">ğŸŒªï¸ ç­›é€‰</button>
        </div>

        <div id="tab-content">
            
            <div class="view-section" id="view-card">
                <div class="glass-card text-center py-5 position-relative">
                    <div class="form-check form-switch position-absolute top-0 end-0 m-3">
                        <input class="form-check-input" type="checkbox" id="mistake-mode" onchange="toggleMistakeMode()">
                        <label class="form-check-label small text-muted">åªçœ‹é”™é¢˜</label>
                    </div>
                    
                    <div class="mb-4">
                        <span class="badge bg-secondary bg-opacity-10 text-secondary border rounded-pill" id="tag-grade">Grade</span> 
                        <span class="badge bg-info bg-opacity-10 text-info border rounded-pill" id="tag-topic">Topic</span>
                    </div>

                    <h1 class="word-text mb-2" id="card-spelling">Hi!</h1>
                    <div class="phonetic mb-4 text-muted fst-italic" id="card-pos">...</div>
                    
                    <div class="collapse" id="meaning-box">
                        <div class="p-4 bg-light bg-opacity-50 rounded-4 mb-3">
                            <h3 class="text-primary fw-bold m-0" id="card-meaning">...</h3>
                        </div>
                    </div>

                    <div class="mt-5 d-flex justify-content-center gap-3">
                        <button class="btn btn-light rounded-circle shadow-sm p-3" onclick="speakCurrentWord()">ğŸ”Š</button>
                        <button class="btn btn-primary rounded-pill px-5 py-3 shadow fw-bold" onclick="toggleMeaning()">æ˜¾ç¤ºé‡Šä¹‰</button>
                        <button class="btn btn-light rounded-circle shadow-sm p-3" onclick="nextWord()">âœ</button>
                    </div>
                </div>
            </div>

            <div class="view-section d-none" id="view-spell">
                
                <div id="spell-normal-mode" class="glass-card text-center py-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                         <h6 class="text-muted fw-bold m-0">æ‹¼å†™ç»ƒä¹ </h6>
                         <button class="btn btn-sm btn-danger rounded-pill shadow-sm fw-bold" onclick="startSpeedRun()">âš¡ 60ç§’æŒ‘æˆ˜</button>
                    </div>
                    
                    <div class="btn-group mb-4 shadow-sm rounded-pill w-100">
                        <button class="btn btn-sm spell-diff-btn rounded-start-pill" id="spell-btn-easy" onclick="setSpellDifficulty('easy')">ğŸŸ¢ ç®€å•</button>
                        <button class="btn btn-sm spell-diff-btn" id="spell-btn-mid" onclick="setSpellDifficulty('mid')">ğŸŸ¡ æ™®é€š</button>
                        <button class="btn btn-sm spell-diff-btn rounded-end-pill" id="spell-btn-hard" onclick="setSpellDifficulty('hard')">ğŸ”´ å›°éš¾</button>
                    </div>

                    <h2 class="text-primary mb-4 fw-bold" id="spell-meaning">...</h2>
                    <input type="text" id="spell-input" class="login-input text-center fs-5 mb-2" placeholder="è¾“å…¥è‹±æ–‡æ‹¼å†™..." autocomplete="off">
                    <div id="spell-feedback" class="mb-3 fw-bold" style="height: 24px;"></div>
                    
                    <div class="d-flex justify-content-center gap-2 mb-4">
                        <button class="btn btn-sm btn-outline-warning rounded-pill px-3" onclick="showHint()">ğŸ’¡ æç¤º</button>
                        <button class="btn btn-sm btn-outline-info rounded-pill px-3" onclick="speakCurrentWord()">ğŸ”Š å¬éŸ³</button>
                        <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" onclick="skipSpell()">â­ï¸ è·³è¿‡</button>
                    </div>

                    <button class="btn btn-success w-100 rounded-pill py-3 shadow fw-bold" onclick="checkSpelling()">æäº¤ (Enter)</button>
                </div>

                <div id="spell-speed-mode" class="glass-card text-center py-5 d-none" style="border: 2px solid #ff5f6d;">
                    <h2 class="fw-bold text-danger mb-3">âš¡ æé€ŸæŒ‘æˆ˜</h2>
                    <div class="display-1 fw-bold mb-3" id="speed-timer">60</div>
                    <div class="progress mb-4" style="height: 5px;"><div class="timer-bar" id="speed-progress"></div></div>
                    
                    <div class="d-flex justify-content-between mb-3 px-4">
                        <span class="text-muted">å¾—åˆ†: <b id="speed-score" class="text-success fs-4">0</b></span>
                        <span class="text-muted">è¯ä¹‰: <b id="speed-word-cn">...</b></span>
                    </div>
                    
                    <input type="text" id="speed-input" class="login-input text-center fs-4 mb-3" placeholder="å¿«ï¼å¿«ï¼å¿«ï¼" autocomplete="off">
                    <button class="btn btn-secondary w-100 rounded-pill" onclick="stopSpeedRun()">æ”¾å¼ƒæŒ‘æˆ˜</button>
                </div>
            </div>

            <div class="view-section d-none" id="view-speak">
                <div class="glass-card text-center py-5">
                    <h6 class="text-muted fw-bold mb-4">AI å£è¯­æ•™ç»ƒ</h6>
                    <h1 class="display-3 fw-bold mb-5" id="speak-target">...</h1>
                    <button id="mic-btn" class="mic-btn btn btn-primary rounded-circle shadow-lg mb-3 d-flex align-items-center justify-content-center" style="width: 90px; height: 90px; font-size: 2rem;" onclick="startListening()">ğŸ¤</button>
                    <p class="small text-muted" id="speak-status">ç‚¹å‡»éº¦å…‹é£å¼€å§‹è·Ÿè¯»</p>
                    <div class="alert alert-light border-0 small mt-3 mx-auto" style="max-width: 90%;" id="speak-result">ç­‰å¾…è¯­éŸ³è¾“å…¥...</div>
                    <button class="btn btn-link text-muted" onclick="nextWord()">è·³è¿‡</button>
                </div>
            </div>

            <div class="view-section d-none" id="view-list">
                <div class="glass-card p-3" style="min-height: 80vh;">
                    <h5 class="fw-bold mb-3">ğŸ“– å•è¯è¯å…¸</h5>
                    <div class="row g-2 mb-3">
                        <div class="col-3"><select id="list-grade" class="form-select form-select-sm" onchange="renderWordList()"><option value="all">å¹´çº§</option><option value="ä¸ƒå¹´çº§">ä¸ƒå¹´çº§</option><option value="å…«å¹´çº§">å…«å¹´çº§</option><option value="ä¹å¹´çº§">ä¹å¹´çº§</option></select></div>
                        <div class="col-3"><select id="list-topic" class="form-select form-select-sm" onchange="renderWordList()"><option value="all">ä¸»é¢˜</option><option value="food">é£Ÿç‰©</option><option value="animal">åŠ¨ç‰©</option><option value="school">å­¦æ ¡</option></select></div>
                        <div class="col-3"><select id="list-pos" class="form-select form-select-sm" onchange="renderWordList()"><option value="all">è¯æ€§</option><option value="n.">åè¯</option><option value="v.">åŠ¨è¯</option></select></div>
                        <div class="col-3"><select id="list-diff" class="form-select form-select-sm" onchange="renderWordList()"><option value="all">éš¾åº¦</option><option value="easy">æ˜“</option><option value="mid">ä¸­</option><option value="hard">éš¾</option></select></div>
                    </div>
                    
                    <div class="table-responsive rounded-3" style="height: 60vh; overflow-y: auto;">
                        <table class="table table-custom table-borderless mb-0 align-middle"><tbody id="word-list-body"></tbody></table>
                    </div>
                </div>
            </div>

            <div class="view-section d-none" id="view-files">
                <div class="row g-3">
                    <div class="col-6"><div class="glass-card h-100 p-4 text-center" onclick="downloadRules()" style="cursor:pointer"><span class="fs-1">ğŸ“œ</span><h6 class="fw-bold mt-2">è§„åˆ™è¡¨</h6></div></div>
                    <div class="col-6"><div class="glass-card h-100 p-4 text-center" onclick="downloadLogs()" style="cursor:pointer"><span class="fs-1">ğŸ’¾</span><h6 class="fw-bold mt-2">å­¦ä¹ è®°å½•</h6></div></div>
                    
                    <div class="col-12">
                        <div class="glass-card p-3">
                            <h6 class="fw-bold mb-3">ğŸ† æˆå°±å‹‹ç«  (Badges)</h6>
                            <div class="badge-grid" id="badge-wall">
                                </div>
                        </div>
                    </div>
                    
                    <div class="col-12">
                        <div class="glass-card p-3">
                            <h6 class="fw-bold mb-3">âš¡ æé€ŸæŒ‘æˆ˜æ’è¡Œæ¦œ</h6>
                            <ul class="list-group list-group-flush bg-transparent" id="leaderboard-list"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="view-section d-none" id="view-stats">
                <div class="glass-card p-3 mb-3 d-flex justify-content-between align-items-center">
                    <div><h6 class="text-muted small fw-bold">æ­£ç¡®ç‡</h6><h2 class="fw-bold mb-0" id="acc-text">0%</h2></div>
                    <div style="width: 100px; height: 100px;"><canvas id="chart-accuracy"></canvas></div>
                </div>
                
                <div class="glass-card p-3 mb-3">
                    <h6 class="text-muted small fw-bold">7å¤©å­¦ä¹ è¶‹åŠ¿</h6>
                    <div style="height: 120px;"><canvas id="chart-trend"></canvas></div>
                </div>
                
                <div class="row g-3 mb-3">
                    <div class="col-4"><div class="glass-card p-2 text-center"><h4 class="text-success fw-bold m-0" id="stat-correct">0</h4><small>Correct</small></div></div>
                    <div class="col-4"><div class="glass-card p-2 text-center"><h4 class="text-danger fw-bold m-0" id="stat-wrong">0</h4><small>Wrong</small></div></div>
                    <div class="col-4"><div class="glass-card p-2 text-center"><h4 class="text-primary fw-bold m-0" id="stat-total">0</h4><small>Total</small></div></div>
                </div>
                
                <div class="glass-card p-3">
                    <h6 class="text-danger small fw-bold mb-3">é”™é¢˜åˆ†æ (Mistakes)</h6>
                    <div id="mistake-tags" class="d-flex flex-wrap gap-2">
                        <small class="text-muted">æš‚æ— é”™é¢˜ï¼Œç»§ç»­ä¿æŒï¼</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="filterModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content filter-modal-content">
                <div class="modal-body">
                    <h5 class="fw-bold mb-4">å…¨å±€ç»ƒä¹ ç­›é€‰</h5>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">å¹´çº§</label>
                        <div id="filter-grade-opts">
                            <span class="filter-chip active" onclick="selectFilter('grade','all',this)">å…¨éƒ¨</span>
                            <span class="filter-chip" onclick="selectFilter('grade','ä¸ƒå¹´çº§',this)">ä¸ƒå¹´çº§</span>
                            <span class="filter-chip" onclick="selectFilter('grade','å…«å¹´çº§',this)">å…«å¹´çº§</span>
                            <span class="filter-chip" onclick="selectFilter('grade','ä¹å¹´çº§',this)">ä¹å¹´çº§</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="small fw-bold text-muted">ä¸»é¢˜ (AIæ™ºèƒ½)</label>
                        <div id="filter-topic-opts">
                            <span class="filter-chip active" onclick="selectFilter('topic','all',this)">å…¨éƒ¨</span>
                            <span class="filter-chip" onclick="selectFilter('topic','food',this)">é£Ÿç‰©</span>
                            <span class="filter-chip" onclick="selectFilter('topic','animal',this)">åŠ¨ç‰©</span>
                            <span class="filter-chip" onclick="selectFilter('topic','school',this)">å­¦æ ¡</span>
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 rounded-pill" data-bs-dismiss="modal" onclick="applyFilters()">ç¡®è®¤åº”ç”¨</button>
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('view-card', this)"><i>ğŸ´</i><span>å¡ç‰‡</span></button>
        <button class="nav-item" onclick="switchTab('view-spell', this)"><i>âœï¸</i><span>æ‹¼å†™</span></button>
        <button class="nav-item" onclick="switchTab('view-speak', this)"><i>ğŸ¤</i><span>å£è¯­</span></button>
        <button class="nav-item" onclick="switchTab('view-list', this)"><i>ğŸ“œ</i><span>è¯è¡¨</span></button>
        <button class="nav-item" onclick="switchTab('view-files', this)"><i>ğŸ“‚</i><span>æ¡£æ¡ˆ</span></button>
        <button class="nav-item" onclick="switchTab('view-stats', this)"><i>ğŸ“Š</i><span>æ•°æ®</span></button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="word_data.js"></script>

    <script>
        // === é…ç½®ä¸å¸¸é‡ ===
        const dailyQuotes = [
            "Believe you can and you're halfway there.",
            "Dream big and dare to fail.",
            "Stay hungry, stay foolish.",
            "No pain, no gain.",
            "Just do it.",
            "Knowledge is power."
        ];
        
        // å‹‹ç« ç³»ç»Ÿé…ç½®
        const badgesConfig = [
            { id: 1, name: "åˆå­¦è€…", icon: "ğŸŒ±", threshold: 10, desc: "ç´¯è®¡10è¯" },
            { id: 2, name: "æŒ‘æˆ˜è€…", icon: "âš”ï¸", threshold: 50, desc: "ç´¯è®¡50è¯" },
            { id: 3, name: "å¤§å¸ˆ", icon: "ğŸ”¥", threshold: 100, desc: "ç´¯è®¡100è¯" },
            { id: 4, name: "ä¼ å¥‡", icon: "ğŸ‘‘", threshold: 300, desc: "ç´¯è®¡300è¯" },
            { id: 5, name: "è¶…ç¥", icon: "ğŸš€", threshold: 1000, desc: "ç´¯è®¡1000è¯" },
            { id: 6, name: "å¤–æ˜Ÿäºº", icon: "ğŸ‘½", threshold: 2000, desc: "ç´¯è®¡2000è¯" }
        ];
        
        // æ™ºèƒ½åˆ†ç±»å…³é”®è¯
        const topicKeywords = {
            food: ['é£Ÿ','é¥­','è‚‰','æœ','èœ','æ±¤','è›‹','å¥¶','é¸¡','é±¼','ç‰›','çŒª','apple','banana','rice','beef','eat'],
            animal: ['åŠ¨ç‰©','ç‹—','çŒ«','çŒª','é¸Ÿ','é±¼','è™','ç‹®','è±¡','zoo','pet','dog','cat'],
            school: ['ä¹¦','ç¬”','è¯¾','æ ¡','å­¦','ç­','æ•™','å¸ˆ','è€ƒ','book','pen','class','school'],
            body: ['çœ¼','è€³','å£','é¼»','æ‰‹','è„š','å¤´','è„¸','body','eye','hand']
        };

        // å‘éŸ³è§„åˆ™æ•°æ®
        const phoneticRules = [
            { type: "å¼€éŸ³èŠ‚", rule: "å…ƒéŸ³å‘æœ¬éŸ³ (å¦‚ a å‘ /ei/)", example: "cake, like, nose" },
            { type: "é—­éŸ³èŠ‚", rule: "å…ƒéŸ³å‘çŸ­éŸ³ (å¦‚ a å‘ /Ã¦/)", example: "cat, pig, box" },
            { type: "ç»„åˆéŸ³", rule: "ea/ee å‘é•¿éŸ³ /i:/", example: "tea, sheep, see" }
        ];

        // === å…¨å±€å˜é‡ ===
        let currentWord = {};
        let currentMode = 'all'; // 'all' or 'mistake'
        let filteredPool = [];
        let activeFilters = { grade: 'all', topic: 'all', pos: 'all', diff: 'all' };
        
        let currentUser = null;
        let mistakeList = [];
        let stats = { correct: 0, wrong: 0 };
        let learningLogs = [];
        let streak = 0; // è¿èƒœå¤©æ•°
        
        let chartAcc = null;
        let chartTrend = null;
        let spellDifficulty = 'all'; // 'easy', 'mid', 'hard'
        
        // æé€ŸæŒ‘æˆ˜å˜é‡
        let speedTimer = null;
        let speedScore = 0;
        let speedTimeLeft = 60;
        let speedTargetWord = {};

        // === å·¥å…·å‡½æ•° ===
        function fireConfetti() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        // === åˆå§‹åŒ–é€»è¾‘ ===
        window.onload = function() {
            // éšæœºæ¯æ—¥ä¸€å¥
            document.getElementById('daily-quote').innerText = dailyQuotes[Math.floor(Math.random() * dailyQuotes.length)];
            
            // æ¢å¤æ·±è‰²æ¨¡å¼
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
            }
            
            // æ£€æŸ¥è‡ªåŠ¨ç™»å½•
            if (sessionStorage.getItem('login') === 'true') {
                currentUser = sessionStorage.getItem('user');
                loadUserData(currentUser);
                enterApp();
            }
        };

        function toggleTheme() {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }

        // === ç”¨æˆ·ç³»ç»Ÿé€»è¾‘ ===
        function handleLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            
            // ç®€å•éªŒè¯ (å®é™…é¡¹ç›®åº”ç”¨æœåŠ¡å™¨éªŒè¯)
            if (localStorage.getItem('up_' + u) === p) {
                currentUser = u;
                sessionStorage.setItem('login', 'true');
                sessionStorage.setItem('user', u);
                
                loadUserData(u);
                
                // è®¡ç®—è¿èƒœ (Streak)
                const lastLogin = localStorage.getItem('last_login_' + u);
                const today = new Date().toDateString();
                
                if (lastLogin !== today) {
                    // å¦‚æœä¸æ˜¯åŒä¸€å¤©ï¼Œå¢åŠ å¤©æ•°
                    // ç®€åŒ–é€»è¾‘ï¼šæ¯æ¬¡ç™»å½•ä¸åŒå¤©æ•°éƒ½+1ï¼Œä¸è€ƒè™‘æ–­ç­¾
                    streak = (parseInt(localStorage.getItem('streak_' + u)) || 0) + 1;
                    localStorage.setItem('streak_' + u, streak);
                    localStorage.setItem('last_login_' + u, today);
                } else {
                    streak = parseInt(localStorage.getItem('streak_' + u)) || 0;
                }
                
                enterApp();
            } else {
                alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
            }
        }

        function handleRegister() {
            const u = document.getElementById('reg-user').value.trim();
            const p = document.getElementById('reg-pass').value.trim();
            if (u && p) {
                if (localStorage.getItem('up_' + u)) {
                    alert("è´¦å·å·²å­˜åœ¨");
                } else {
                    localStorage.setItem('up_' + u, p);
                    alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•");
                    showLogin();
                }
            } else {
                alert("è´¦å·å¯†ç ä¸èƒ½ä¸ºç©º");
            }
        }

        function showRegister() {
            document.getElementById('login-box').style.display = 'none';
            document.getElementById('register-box').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('register-box').style.display = 'none';
            document.getElementById('login-box').style.display = 'block';
        }

        function logout() {
            if (confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—?")) {
                sessionStorage.clear();
                location.reload();
            }
        }

        // === æ•°æ®å­˜å– (Local Storage) ===
        function loadUserData(u) {
            mistakeList = JSON.parse(localStorage.getItem('mis_' + u)) || [];
            stats = JSON.parse(localStorage.getItem('sta_' + u)) || { correct: 0, wrong: 0 };
            learningLogs = JSON.parse(localStorage.getItem('log_' + u)) || [];
        }

        function saveUserData() {
            if (!currentUser) return;
            localStorage.setItem('mis_' + currentUser, JSON.stringify(mistakeList));
            localStorage.setItem('sta_' + currentUser, JSON.stringify(stats));
            localStorage.setItem('log_' + currentUser, JSON.stringify(learningLogs));
        }

        function addLog(word, mode, result) {
            learningLogs.unshift({
                time: new Date().toLocaleDateString(),
                word: word,
                mode: mode,
                result: result
            });
            // é™åˆ¶æ—¥å¿—é•¿åº¦
            if (learningLogs.length > 200) learningLogs = learningLogs.slice(0, 200);
            saveUserData();
        }

        // === è¿›å…¥ä¸»åº”ç”¨ ===
        function enterApp() {
            // åˆ‡æ¢åŠ¨ç”»
            document.getElementById('login-screen').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                setTimeout(() => document.getElementById('main-app').style.opacity = '1', 50);
            }, 500);
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            document.getElementById('welcome-name').innerText = currentUser;
            document.getElementById('streak-days').innerText = streak;
            document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${currentUser}&background=random&color=fff`;
            
            // é¢„å¤„ç†å•è¯æ•°æ® (æ‰“æ ‡ç­¾)
            tagWords();
            
            // åˆå§‹åŒ–å„ä¸ªæ¨¡å—
            applyFilters();
            renderWordList();
            updateStats();
            renderBadges();
            updateLeaderboard();
        }

        // ç»™å•è¯æ‰“ä¸Šæ™ºèƒ½æ ‡ç­¾ (Topic & Difficulty)
        function tagWords() {
            wordLibrary.forEach(w => {
                // éš¾åº¦åˆ†çº§
                if (w.unit.includes('ä¸ƒå¹´çº§')) w._diff = 'easy';
                else if (w.unit.includes('å…«å¹´çº§')) w._diff = 'mid';
                else w._diff = 'hard';
                
                // ä¸»é¢˜å½’ç±»
                w._topic = 'others';
                const text = (w.meaning + w.spelling).toLowerCase();
                for (const [topic, keywords] of Object.entries(topicKeywords)) {
                    if (keywords.some(k => text.includes(k))) {
                        w._topic = topic;
                        break;
                    }
                }
            });
        }

        // === æ ¸å¿ƒé€»è¾‘: å•è¯æŠ½å–ä¸åˆ‡æ¢ ===
        function nextWord() {
            let pool = filteredPool;
            
            // å¦‚æœæ˜¯åœ¨æ‹¼å†™ç•Œé¢ï¼Œä¸”é€‰æ‹©äº†ç‰¹å®šéš¾åº¦ï¼Œåˆ™è¿›ä¸€æ­¥è¿‡æ»¤
            const isSpellView = !document.getElementById('view-spell').classList.contains('d-none');
            if (isSpellView && spellDifficulty !== 'all') {
                pool = filteredPool.filter(w => w._diff === spellDifficulty);
            }

            if (pool.length === 0) {
                alert("å½“å‰ç­›é€‰ä¸‹æ²¡æœ‰å•è¯ï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶ï¼");
                return;
            }
            
            // éšæœºæŠ½å–
            currentWord = pool[Math.floor(Math.random() * pool.length)];
            
            // æ›´æ–° UI (å¡ç‰‡ã€æ‹¼å†™ã€å£è¯­)
            updateWordUI();
        }

        function updateWordUI() {
            // 1. å¡ç‰‡é¡µ
            document.getElementById('card-spelling').innerText = currentWord.spelling;
            document.getElementById('card-meaning').innerText = currentWord.meaning;
            document.getElementById('card-pos').innerText = currentWord.part_of_speech || '';
            document.getElementById('meaning-box').classList.remove('show'); // éšè—é‡Šä¹‰
            
            document.getElementById('tag-grade').innerText = currentWord.unit.split('(')[0];
            document.getElementById('tag-topic').innerText = currentWord._topic.toUpperCase();

            // 2. æ‹¼å†™é¡µ
            document.getElementById('spell-meaning').innerText = currentWord.meaning;
            document.getElementById('spell-input').value = ""; 
            document.getElementById('spell-feedback').innerHTML = "";
            
            // 3. å£è¯­é¡µ
            document.getElementById('speak-target').innerText = currentWord.spelling;
            document.getElementById('speak-result').innerText = "ç‚¹å‡»éº¦å…‹é£å¼€å§‹è·Ÿè¯»...";
            document.getElementById('speak-result').className = "alert alert-light border-0 small mt-3 mx-auto";
        }

        // === åŠŸèƒ½æ¨¡å— 1: æ‹¼å†™ç»ƒä¹ æ•‘æ´ç³»ç»Ÿ ===
        function showHint() {
            const fb = document.getElementById('spell-feedback');
            fb.innerHTML = `<span class="text-warning fw-bold fs-4">${currentWord.spelling}</span>`;
            setTimeout(() => { fb.innerHTML = ""; }, 3000); // 3ç§’åè‡ªåŠ¨éšè—
        }

        function skipSpell() {
            stats.wrong++; 
            addLog(currentWord.spelling, "Spell", "â­ï¸ è·³è¿‡"); 
            document.getElementById('spell-feedback').innerHTML = '<span class="text-muted">å·²è·³è¿‡</span>';
            
            // è·³è¿‡ä¹Ÿç®—ä¸€ç§"ä¸ä¼š"ï¼ŒåŠ å…¥é”™é¢˜
            if (!mistakeList.includes(currentWord.id)) mistakeList.push(currentWord.id);
            
            setTimeout(nextWord, 800); 
            saveUserData(); 
            updateStats();
        }

        function checkSpelling() {
            const val = document.getElementById('spell-input').value.trim().toLowerCase();
            const target = currentWord.spelling.toLowerCase();
            const fb = document.getElementById('spell-feedback');
            
            if (val === target) {
                fb.innerHTML = '<span class="text-success fw-bold">Correct! âœ¨</span>';
                fireConfetti(); // ç­”å¯¹æ”¾çƒŸèŠ±
                stats.correct++;
                
                // å¦‚æœæ˜¯é”™é¢˜æ¨¡å¼ç­”å¯¹äº†ï¼Œç§»å‡ºé”™é¢˜æœ¬
                if (currentMode === 'mistake') {
                    mistakeList = mistakeList.filter(i => i !== currentWord.id);
                }
                addLog(currentWord.spelling, "Spell", "âœ… æ­£ç¡®");
                setTimeout(nextWord, 1000);
            } else {
                fb.innerHTML = '<span class="text-danger fw-bold">Wrong! Try again.</span>';
                stats.wrong++;
                if (!mistakeList.includes(currentWord.id)) mistakeList.push(currentWord.id);
                addLog(currentWord.spelling, "Spell", "âŒ é”™è¯¯");
            }
            saveUserData();
            updateStats();
        }

        // === åŠŸèƒ½æ¨¡å— 2: æé€ŸæŒ‘æˆ˜ (60s Challenge) ===
        function startSpeedRun() {
            document.getElementById('spell-normal-mode').classList.add('d-none');
            document.getElementById('spell-speed-mode').classList.remove('d-none');
            
            speedScore = 0;
            speedTimeLeft = 60;
            document.getElementById('speed-score').innerText = 0;
            
            nextSpeedWord();
            
            // å€’è®¡æ—¶é€»è¾‘
            speedTimer = setInterval(() => {
                speedTimeLeft--;
                document.getElementById('speed-timer').innerText = speedTimeLeft;
                document.getElementById('speed-progress').style.width = (speedTimeLeft / 60 * 100) + "%";
                
                if (speedTimeLeft <= 0) {
                    endSpeedRun();
                }
            }, 1000);
            
            document.getElementById('speed-input').focus();
        }
        
        function nextSpeedWord() {
            speedTargetWord = wordLibrary[Math.floor(Math.random() * wordLibrary.length)];
            document.getElementById('speed-word-cn').innerText = speedTargetWord.meaning;
            document.getElementById('speed-input').value = "";
        }
        
        // æé€Ÿæ¨¡å¼ç›‘å¬è¾“å…¥
        document.getElementById('speed-input').addEventListener('input', function(e) {
            if (this.value.trim().toLowerCase() === speedTargetWord.spelling.toLowerCase()) {
                speedScore++;
                document.getElementById('speed-score').innerText = speedScore;
                fireConfetti(); // æé€Ÿæ¨¡å¼æ¯é¢˜éƒ½æ”¾çƒŸèŠ±
                nextSpeedWord();
            }
        });

        function endSpeedRun() {
            clearInterval(speedTimer);
            alert(`æ—¶é—´åˆ°ï¼æœ€ç»ˆå¾—åˆ†: ${speedScore}`);
            
            // æ›´æ–°æœ€é«˜åˆ†
            let best = parseInt(localStorage.getItem('best_' + currentUser)) || 0;
            if (speedScore > best) {
                localStorage.setItem('best_' + currentUser, speedScore);
                alert("ğŸ‰ æ­å–œï¼æ‰“ç ´æœ€é«˜çºªå½•ï¼");
            }
            updateLeaderboard();
            stopSpeedRun();
        }

        function stopSpeedRun() {
            clearInterval(speedTimer);
            document.getElementById('spell-speed-mode').classList.add('d-none');
            document.getElementById('spell-normal-mode').classList.remove('d-none');
        }
        
        function updateLeaderboard() {
            const best = localStorage.getItem('best_' + currentUser) || 0;
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = `
                <li class="list-group-item bg-transparent d-flex justify-content-between">
                    <span>ğŸ¥‡ ${currentUser} (ä½ )</span>
                    <span class="fw-bold text-success">${best} åˆ†</span>
                </li>
                <li class="list-group-item bg-transparent d-flex justify-content-between text-muted">
                    <span>ğŸ¥ˆ AI Robot</span>
                    <span>15 åˆ†</span>
                </li>
            `;
        }

        // === åŠŸèƒ½æ¨¡å— 3: è¯­éŸ³è¯„æµ‹ ===
        function startListening() {
            if (!('webkitSpeechRecognition' in window)) {
                return alert("æŠ±æ­‰ï¼Œè¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨ä½“éªŒè¯­éŸ³åŠŸèƒ½ã€‚");
            }
            
            const btn = document.getElementById('mic-btn');
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            
            recognition.onstart = () => btn.classList.add('recording');
            recognition.onend = () => btn.classList.remove('recording');
            
            recognition.onresult = (e) => {
                const transcript = e.results[0][0].transcript.toLowerCase();
                if (transcript.includes(currentWord.spelling.toLowerCase())) {
                    document.getElementById('speak-result').className = "alert alert-success border-0 small mt-3 mx-auto";
                    document.getElementById('speak-result').innerHTML = "<strong>Perfect! å®Œç¾!</strong>";
                    fireConfetti();
                    addLog(currentWord.spelling, "Speak", "âœ… å®Œç¾");
                    setTimeout(nextWord, 1000);
                } else {
                    document.getElementById('speak-result').className = "alert alert-danger border-0 small mt-3 mx-auto";
                    document.getElementById('speak-result').innerText = `è¯†åˆ«ç»“æœ: ${transcript}`;
                    addLog(currentWord.spelling, "Speak", "âŒ ä¸€èˆ¬");
                }
            };
            recognition.start();
        }

        // === åŠŸèƒ½æ¨¡å— 4: æ•°æ®ç»Ÿè®¡ä¸å‹‹ç«  ===
        function updateStats() {
            const t = stats.correct + stats.wrong;
            document.getElementById('stat-correct').innerText = stats.correct;
            document.getElementById('stat-wrong').innerText = stats.wrong;
            document.getElementById('stat-total').innerText = t;
            
            const acc = t === 0 ? 0 : Math.round((stats.correct / t) * 100);
            document.getElementById('acc-text').innerText = acc + "%";
            
            // æ›´æ–°å›¾è¡¨ (Chart.js)
            renderCharts();
            
            // æ›´æ–°å‹‹ç« 
            renderBadges();
            
            // æ›´æ–°é”™é¢˜é¢„è§ˆ
            const errs = wordLibrary.filter(w => mistakeList.includes(w.id)).slice(0, 8);
            const tagContainer = document.getElementById('mistake-tags');
            if (errs.length === 0) {
                tagContainer.innerHTML = '<small class="text-muted">æš‚æ— é”™é¢˜ï¼Œç»§ç»­ä¿æŒï¼</small>';
            } else {
                tagContainer.innerHTML = errs.map(w => 
                    `<span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 rounded-pill">${w.spelling}</span>`
                ).join('');
            }
        }

        function renderCharts() {
            // å‡†ç¡®ç‡ç¯å½¢å›¾
            if (chartAcc) chartAcc.destroy();
            const ctx1 = document.getElementById('chart-accuracy').getContext('2d');
            chartAcc = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['æ­£ç¡®', 'é”™è¯¯'],
                    datasets: [{
                        data: [stats.correct, stats.wrong],
                        backgroundColor: ['#00b09b', '#ff5f6d'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '80%',
                    plugins: { legend: { display: false } }
                }
            });
            
            // è¶‹åŠ¿å›¾ (æ¨¡æ‹Ÿæ•°æ®)
            if (chartTrend) chartTrend.destroy();
            const ctx2 = document.getElementById('chart-trend').getContext('2d');
            const g = ctx2.createLinearGradient(0, 0, 0, 100);
            g.addColorStop(0, 'rgba(106, 17, 203, 0.5)');
            g.addColorStop(1, 'rgba(106, 17, 203, 0)');
            
            chartTrend = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                    datasets: [{
                        data: [2, 5, 3, 8, stats.correct + stats.wrong, stats.correct + stats.wrong + 2, stats.correct + stats.wrong + 5],
                        borderColor: '#6a11cb',
                        backgroundColor: g,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        function renderBadges() {
            const total = stats.correct + stats.wrong;
            const container = document.getElementById('badge-wall');
            container.innerHTML = badgesConfig.map(b => {
                const isUnlocked = total >= b.threshold;
                return `
                <div class="achievement-badge ${isUnlocked ? 'unlocked' : ''}">
                    <div class="badge-icon">${b.icon}</div>
                    <div class="badge-name">${b.name}</div>
                    <div class="badge-req">${isUnlocked ? 'å·²è§£é”' : 'éœ€' + b.threshold + 'è¯'}</div>
                </div>`;
            }).join('');
        }

        // === ç­›é€‰ä¸åˆ—è¡¨ ===
        function applyFilters() {
            filteredPool = wordLibrary.filter(w => {
                // å¹´çº§ç­›é€‰
                if (activeFilters.grade !== 'all' && !w.unit.includes(activeFilters.grade)) return false;
                // ä¸»é¢˜ç­›é€‰
                if (activeFilters.topic !== 'all' && w._topic !== activeFilters.topic) return false;
                // è¯æ€§ç­›é€‰
                if (activeFilters.pos !== 'all' && (!w.part_of_speech || !w.part_of_speech.includes(activeFilters.pos))) return false;
                // é”™é¢˜æ¨¡å¼
                if (currentMode === 'mistake' && !mistakeList.includes(w.id)) return false;
                
                return true;
            });
            nextWord();
        }

        function selectFilter(type, value, element) {
            activeFilters[type] = value;
            // æ›´æ–° UI é€‰ä¸­çŠ¶æ€
            const parent = document.getElementById(`filter-${type}-opts`);
            parent.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            element.classList.add('active');
        }

        function setSpellDifficulty(diff) {
            spellDifficulty = diff;
            // æ›´æ–° UI
            document.querySelectorAll('.spell-diff-btn').forEach(b => {
                b.classList.remove('active-easy', 'active-mid', 'active-hard');
                if (diff === 'easy' && b.id === 'spell-btn-easy') b.classList.add('active-easy');
                if (diff === 'mid' && b.id === 'spell-btn-mid') b.classList.add('active-mid');
                if (diff === 'hard' && b.id === 'spell-btn-hard') b.classList.add('active-hard');
            });
            nextWord();
        }

        function renderWordList() {
            // è·å–åˆ—è¡¨é¡µçš„ç­›é€‰æ¡ä»¶
            const fGrade = document.getElementById('list-grade').value;
            const fTopic = document.getElementById('list-topic').value;
            const fPos = document.getElementById('list-pos').value;
            const fDiff = document.getElementById('list-diff').value;

            // ç­›é€‰
            const list = wordLibrary.filter(w => {
                if (fGrade !== 'all' && !w.unit.includes(fGrade)) return false;
                if (fTopic !== 'all' && w._topic !== fTopic) return false;
                if (fPos !== 'all' && (!w.part_of_speech || !w.part_of_speech.includes(fPos))) return false;
                if (fDiff !== 'all' && w._diff !== fDiff) return false;
                return true;
            }).slice(0, 100); // æ€§èƒ½ä¼˜åŒ–ï¼šåªæ˜¾ç¤ºå‰100ä¸ª

            // æ¸²æŸ“
            document.getElementById('word-list-body').innerHTML = list.map(w => `
                <tr>
                    <td>
                        <div class="fw-bold">${w.spelling}</div>
                        <small class="text-muted">${w.part_of_speech || ''}</small>
                    </td>
                    <td><small>${w.meaning}</small></td>
                    <td><span class="badge bg-light text-dark border">${w.unit.substr(0, 3)}</span></td>
                    <td><span onclick="speakWord('${w.spelling}')" style="cursor:pointer">ğŸ”Š</span></td>
                </tr>
            `).join('');
        }

        // === æ–‡ä»¶ä¸‹è½½ ===
        function downloadRules() {
            let csv = "\uFEFFç±»å‹,è§„åˆ™,ç¤ºä¾‹\n" + phoneticRules.map(r => `${r.type},${r.rule},"${r.example}"`).join('\n');
            saveFile(csv, "å‘éŸ³è§„åˆ™è¡¨.csv");
        }

        function downloadLogs() {
            if (learningLogs.length === 0) return alert("æš‚æ— è®°å½•");
            let csv = "\uFEFFæ—¥æœŸ,å•è¯,æ¨¡å¼,ç»“æœ\n" + learningLogs.map(l => `${l.time},${l.word},${l.mode},${l.result}`).join('\n');
            saveFile(csv, `å­¦ä¹ è®°å½•_${currentUser}.csv`);
        }

        function saveFile(content, fileName) {
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([content], { type: 'text/csv;charset=utf-8;' }));
            a.download = fileName;
            a.click();
        }

        // === è¾…åŠ©åŠŸèƒ½ ===
        function toggleMeaning() { document.getElementById('meaning-box').classList.toggle('show'); }
        function toggleMistakeMode() { currentMode = document.getElementById('mistake-mode').checked ? 'mistake' : 'all'; applyFilters(); }
        function speakCurrentWord() { speakWord(currentWord.spelling); }
        function speakWord(text) { const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; speechSynth.speak(u); }
        const speechSynth = window.speechSynthesis;

        function switchTab(tabId, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('d-none'));
            document.getElementById(tabId).classList.remove('d-none');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            
            if (tabId === 'view-spell') nextWord();
            if (tabId === 'view-stats') updateStats();
            if (tabId === 'view-list') renderWordList();
        }

        function searchWord(val) {
            if (!val) return applyFilters();
            filteredPool = wordLibrary.filter(w => w.spelling.toLowerCase().includes(val.toLowerCase()));
            if (filteredPool.length) {
                currentWord = filteredPool[0];
                updateWordUI();
            }
        }
        
        function filterUnit(u) {
            activeFilters.grade = u;
            applyFilters();
        }

    </script>
</body>
</html>